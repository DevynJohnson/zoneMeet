generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


model User {
  id            String    @id @default(cuid())
  email         String    @unique
  firstName     String?
  lastName      String?
  phone         String?
  emailVerified DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  bookings      Booking[]

  @@map("users")
}

model Provider {
  id                     String                 @id @default(cuid())
  name                   String
  email                  String                 @unique
  phone                  String?
  passwordHash           String?
  isActive               Boolean                @default(true)
  company                String?
  title                  String?
  bio                    String?
  website                String?
  defaultBookingDuration Int                    @default(60)
  bufferTime             Int                    @default(15)
  advanceBookingDays     Int                    @default(30)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  allowedDurations       Int[]                  @default([15, 30, 45, 60, 90])
  availabilityTemplates  AvailabilityTemplate[]
  bookings               Booking[]
  calendarConnections    CalendarConnection[]
  calendarEvents         CalendarEvent[]
  locations              ProviderLocation[]
  refreshTokens          RefreshToken[]
  passwordResetTokens    PasswordResetToken[]
  auditLogs              AuditLog[]

  @@map("providers")
}

model RefreshToken {
  id         String   @id @default(cuid())
  providerId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  isRevoked  Boolean  @default(false)
  revokedAt  DateTime?
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  providerId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  usedAt     DateTime?
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model AuditLog {
  id         String   @id @default(cuid())
  providerId String
  action     String
  details    Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

model ProviderLocation {
  id             String             @id @default(cuid())
  providerId     String
  city           String
  stateProvince  String
  postalCode     String?
  country        String
  description    String?
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean            @default(true)
  isDefault      Boolean            @default(false)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  timezone       String             @default("America/New_York")
  addressLine1   String?            
  addressLine2   String?            
  schedules      LocationSchedule[]
  provider       Provider           @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([startDate, endDate])
  @@index([city, stateProvince, country])
  @@index([providerId, isDefault])
  @@map("provider_locations")
}

model LocationSchedule {
  id                 String           @id @default(cuid())
  locationId         String
  startDate          DateTime
  endDate            DateTime?
  isRecurring        Boolean          @default(false)
  recurrenceType     RecurrenceType?
  recurrenceInterval Int?
  daysOfWeek         Int[]            @default([])
  weekOfMonth        Int?
  monthOfYear        Int?
  recurrenceEndDate  DateTime?
  occurrenceCount    Int?
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  location           ProviderLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
  @@index([startDate, endDate])
  @@index([isRecurring, recurrenceType])
  @@map("location_schedules")
}

model CalendarConnection {
  id                   String           @id @default(cuid())
  providerId           String
  platform             CalendarPlatform
  email                String
  calendarId           String
  calendarName         String?
  accessToken          String
  refreshToken         String?
  tokenExpiry          DateTime?
  isDefaultForBookings Boolean          @default(false)
  syncEvents           Boolean          @default(true)
  allowBookings        Boolean          @default(true)
  selectedCalendars    Json?
  calendarSettings     Json?
  isActive             Boolean          @default(true)
  lastSyncAt           DateTime?
  syncFrequency        Int              @default(15)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  provider             Provider         @relation(fields: [providerId], references: [id], onDelete: Cascade)
  events               CalendarEvent[]

  @@unique([providerId, platform, calendarId])
  @@index([providerId, isDefaultForBookings])
  @@map("calendar_connections")
}

model CalendarEvent {
  id                String             @id @default(cuid())
  providerId        String
  connectionId      String
  externalEventId   String
  platform          CalendarPlatform
  calendarId        String
  title             String
  description       String?
  startTime         DateTime
  endTime           DateTime
  isAllDay          Boolean            @default(false)
  location          String?
  city              String?
  state             String?
  address           String?
  lat               Float?
  lng               Float?
  allowBookings     Boolean            @default(false)
  maxBookings       Int                @default(1)
  availableServices String[]           @default([])
  lastSyncAt        DateTime           @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  bookings          Booking[]
  connection        CalendarConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  provider          Provider           @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([externalEventId, platform, calendarId])
  @@index([providerId, startTime])
  @@index([startTime, endTime])
  @@index([city, state])
  @@map("calendar_events")
}

model Booking {
  id              String         @id @default(cuid())
  customerId      String
  providerId      String
  calendarEventId String?
  scheduledAt     DateTime
  duration        Int
  status          BookingStatus  @default(PENDING)
  serviceType     String
  notes           String?
  estimatedCost   Float?
  finalCost       Float?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  calendarEvent   CalendarEvent? @relation(fields: [calendarEventId], references: [id])
  customer        User           @relation(fields: [customerId], references: [id])
  provider        Provider       @relation(fields: [providerId], references: [id])

  @@index([scheduledAt])
  @@index([providerId, scheduledAt])
  @@index([calendarEventId])
  @@map("bookings")
}

model MagicLink {
  id        String           @id @default(cuid())
  email     String
  token     String           @unique
  purpose   MagicLinkPurpose
  data      Json?
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([token])
  @@index([email, expiresAt])
  @@map("magic_links")
}

model AvailabilityTemplate {
  id                    String                 @id @default(cuid())
  providerId            String
  name                  String
  isDefault             Boolean                @default(false)
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  timezone              String                 @default("America/New_York")
  availabilitySchedules AvailabilitySchedule[]
  provider              Provider               @relation(fields: [providerId], references: [id], onDelete: Cascade)
  timeSlots             AvailabilityTimeSlot[]
  assignments           TemplateAssignment[]

  @@index([providerId, isDefault])
  @@index([providerId, isActive])
  @@map("availability_templates")
}

model AvailabilitySchedule {
  id                 String                         @id @default(cuid())
  templateId         String                         @map("template_id")
  name               String
  startDate          DateTime                       @map("start_date")
  endDate            DateTime?                      @map("end_date")
  isRecurring        Boolean                        @default(false) @map("is_recurring")
  recurrenceType     RecurrenceType?                @map("recurrence_type")
  recurrenceInterval Int?                           @map("recurrence_interval")
  daysOfWeek         Int[]                          @default([]) @map("days_of_week")
  weekOfMonth        Int?                           @map("week_of_month")
  monthOfYear        Int?                           @map("month_of_year")
  recurrenceEndDate  DateTime?                      @map("recurrence_end_date")
  occurrenceCount    Int?                           @map("occurrence_count")
  isActive           Boolean                        @default(true) @map("is_active")
  priority           Int                            @default(0)
  createdAt          DateTime                       @default(now()) @map("created_at")
  updatedAt          DateTime                       @default(now()) @map("updated_at")
  timeSlots          AvailabilityScheduleTimeSlot[] @relation("ScheduleTimeSlots")
  template           AvailabilityTemplate           @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([isRecurring, recurrenceType])
  @@index([startDate, endDate])
  @@index([templateId])
  @@index([templateId, priority])
  @@map("availability_schedules")
}

model AvailabilityTimeSlot {
  id         String               @id @default(cuid())
  templateId String
  dayOfWeek  Int
  startTime  String
  endTime    String
  isEnabled  Boolean              @default(true)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  template   AvailabilityTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, dayOfWeek])
  @@index([dayOfWeek, startTime, endTime])
  @@map("availability_time_slots")
}

model AvailabilityScheduleTimeSlot {
  id         String               @id @default(cuid())
  scheduleId String               @map("schedule_id")
  dayOfWeek  Int                  @map("day_of_week")
  startTime  String               @map("start_time")
  endTime    String               @map("end_time")
  isEnabled  Boolean              @default(true) @map("is_enabled")
  createdAt  DateTime             @default(now()) @map("created_at")
  updatedAt  DateTime             @default(now()) @map("updated_at")
  weekNumber Int?                 @default(0) @map("week_number")
  schedule   AvailabilitySchedule @relation("ScheduleTimeSlots", fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([dayOfWeek, startTime, endTime])
  @@index([scheduleId, dayOfWeek])
  @@index([scheduleId, weekNumber])
  @@map("availability_schedule_time_slots")
}

model TemplateAssignment {
  id         String               @id @default(cuid())
  templateId String
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  template   AvailabilityTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, startDate, endDate])
  @@index([startDate, endDate])
  @@map("template_assignments")
}

enum RecurrenceType {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  BIMONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum CalendarPlatform {
  OUTLOOK
  GOOGLE
  TEAMS
  APPLE
  OTHER
}

enum MagicLinkPurpose {
  LOGIN
  BOOK_APPOINTMENT
  MODIFY_BOOKING
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}
